
# 记忆同步架构重构计划
===================

## 问题诊断
--------

### 当前问题
--------
1. **异步同步不可靠**：使用后台线程异步同步，没有确保同步成功的机制
2. **向量存储懒加载导致同步失败**：首次同步时向量存储可能未初始化
3. **缺少同步确认机制缺失**：SQLite保存成功后，只是把同步任务加入队列就返回
4. **同步失败无回滚**：向量存储同步失败没有错误处理

### 根本原因
--------
`DataSyncManager` 使用异步队列 + 后台线程处理同步，这种架构本身就无法保证数据一致性。

解决方案
--------

### 新架构设计
------------

#### 核心思路：同步写入模式
--------
1. 保存记忆时，SQLite 和向量存储**都成功**才返回
2. 移除异步同步队列和后台线程
3. 移除全量同步检查机制
4. 简化架构，一步到位

### 修改文件清单
--------

1. **`src/finchbot/memory/vector_sync.py`
--------
- 简化 `DataSyncManager`，移除后台线程、同步队列
- 只保留简单的同步状态统计
- 保留 `VectorStoreAdapter` 不变

2. **`src/finchbot/memory/manager.py`**
--------
- 修改 `remember()` 方法，直接同步写入向量存储
- 修改 `update_memory()` 方法，直接同步更新向量存储
- 修改 `forget()`、`archive_memory()`、`unarchive_memory()` 方法，直接同步操作
- 简化 `close()` 方法，移除 `sync_manager.stop()` 调用

实施步骤
--------

1. 修改 `vector_sync.py`：简化 `DataSyncManager`
2. 修改 `manager.py`：改为同步写入
3. 测试新架构
4. 运行现有测试通过

风险评估
--------

### 风险点
--------
- **性能影响：首次保存会稍慢（但确保了数据一致性更重要）
- **向后兼容性：完全移除旧架构，不向后兼容
- **初始化：需要确保向量存储可用

验收标准
--------
1. 所有记忆操作都能同时写入 SQLite 和向量存储
2. 不再有未同步的记忆
3. 不再有错误提示明确（如果向量存储不可用）
4. 现有测试通过
